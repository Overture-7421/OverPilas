<!DOCTYPE html>
<html>
<head>
    <title>Registro de Pilas</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background-color: #E6E0F8; /* morado clarito */
            text-align: center; 
            margin: 50px; 
        }
        h1, h2 { color: #4B0082; } /* morado oscuro */
        form { margin-bottom: 30px; }
        select, input { margin: 5px; padding: 8px; width: 200px; }
        
        /* Contenedor para las tres secciones lado a lado */
        .formularios-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }
        
        .registro-section, .pila-uso-section, .recibir-section {
            flex: 1;
            max-width: 300px;
            min-width: 250px;
        }
        
        .registro-section {
            background-color: #F3F0FF;
            border: 2px solid #9370DB;
            border-radius: 10px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 250px;
            text-align: center;
        }
        
        .registro-section h2 {
            color: #4B0082;
            margin-top: 0;
        }
        
        /* Estilos para campos en l√≠nea */
        .campo-linea {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 8px 0;
            gap: 10px;
        }
        
        .campo-linea label {
            flex: 1;
            text-align: left;
            font-weight: normal;
        }
        
        .campo-linea select,
        .campo-linea input {
            flex: 1;
            margin: 0;
        }
        button { padding: 8px 15px; background-color: #9370DB; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #7B68EE; }
        table { margin: 0 auto; border-collapse: collapse; width: 60%; }
        th, td { border: 1px solid #aaa; padding: 10px; text-align: center; }
        th { background-color: #D8BFD8; }
        
        /* Estilo para pila en uso */
        .en-uso {
            color: #059669;
            font-weight: bold;
        }
        
        /* Estilo para pila en cooldown */
        .en-cooldown {
            color: #DC2626;
            font-weight: bold;
        }
        
        /* Estilo para pila lista para conectar */
        .lista-conectar {
            color: #D97706;
            font-weight: bold;
        }
        
        /* Secci√≥n de pila en uso - verde claro */
        .pila-uso-section {
            background-color: #F0FDF4;
            border: 2px solid #22C55E;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 250px;
        }
        
        .pila-uso-section h2 {
            color: #15803D;
            margin-top: 0;
        }
        
        /* Secci√≥n de recibir pila - rojo claro */
        .recibir-section {
            background-color: #FEF2F2;
            border: 2px solid #EF4444;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 250px;
        }
        
        .recibir-section h2 {
            color: #DC2626;
            margin-top: 0;
        }
        
        /* Contenedor para las tablas lado a lado */
        .tablas-container {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }
        
        .tabla-section {
            flex: 1;
            max-width: 500px;
            min-width: 400px;
            background-color: #F3F0FF;
            border: 2px solid #9370DB;
            border-radius: 10px;
            padding: 20px;
        }
        
        .tabla-section h2 {
            color: #4B0082;
            margin-top: 0;
        }
        
        .tabla-section table {
            width: 100%;
            margin: 0;
        }
        
        /* Bot√≥n de reiniciar */
        .reiniciar-btn {
            position: fixed;
            bottom: 20px;
            right: 15px;
            background: linear-gradient(135deg, #DC2626, #EF4444);
            color: white;
            border: none;
            padding: 12px 10px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
            font-size: 14px;
        }
        
        .reiniciar-btn:hover {
            background: linear-gradient(135deg, #B91C1C, #DC2626);
            box-shadow: 0 6px 16px rgba(220, 38, 38, 0.4);
        }

        /* Bot√≥n de informaci√≥n */
        .info-btn {
            position: fixed;
            bottom: 20px;
            left: 15px;
            background: linear-gradient(135deg, #2563EB, #3B82F6);
            color: white;
            border: none;
            padding: 12px 10px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            font-size: 14px;
        }
        
        .info-btn:hover {
            background: linear-gradient(135deg, #1D4ED8, #2563EB);
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.4);
        }

        /* √öltima actualizaci√≥n */
        #ultima {
            position: fixed;
            top: 10px;
            left: 10px;
            font-weight: bold;
            color: white;
            background: linear-gradient(135deg, #6B46C1, #9333EA);
            padding: 10px 12px;
            border-radius: 10px;
            border: 2px solid #7C3AED;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
            font-size: 12px;
            max-width: 120px;
            word-wrap: break-word;
        }
        
        /* Pr√≥ximo chequeo - box m√°s grande y separado */
        #proximo {
            position: fixed;
            top: 80px;
            left: 10px;
            font-weight: bold;
            color: white;
            background: linear-gradient(135deg, #059669, #10B981);
            padding: 12px 16px;
            border-radius: 14px;
            border: 2px solid #047857;
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
            font-size: 14px;
            max-width: 120px;
            word-wrap: break-word;
        }
        
        /* Imagen superior derecha */
        .imagen-superior {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 150px;
            height: 150px;
            border-radius: 10px;
            object-fit: cover;
        }
        
        /* Tabs - barra de navegaci√≥n tipo p√°gina */
        .tabs {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 10px 0 20px 0;
        }

        .tab {
            padding: 8px 14px;
            border-radius: 8px 8px 0 0;
            background: linear-gradient(180deg, #F3F0FF, #EDE9FE);
            border: 2px solid #D6BBFF;
            color: #4B0082;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
        }

        .tab.active {
            background: linear-gradient(180deg, #FFFFFF, #F8F7FF);
            border-bottom: 2px solid transparent;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .tab-panel {
            display: block;
            max-width: 1200px;
            margin: 0 auto 30px auto;
        }

        /* Matches placeholder styling */
        .matches-content {
            background: #FFFFFF;
            border: 2px dashed #C7D2FE;
            padding: 30px;
            border-radius: 10px;
            color: #374151;
        }
        .pila-list-item { margin: 10px 0; padding: 8px; background-color: #E6E0F8; border-radius: 5px; border-left: 4px solid #9370DB; display:flex; justify-content:space-between; align-items:center; }
        .pila-list-item.disabled { background-color: #F3F3F4; color: #9CA3AF; }
        .pila-toggle-btn { color:white; border:none; padding:6px 8px; border-radius:6px; cursor:pointer; }
    /* Pastel orange for the "Inhabilitar Pila" button */
    .pila-toggle-btn.disable { background:#FDBA74; }
        .pila-toggle-btn.enable { background:#9CA3AF; }
    .prestado-card { background:#FBFBFD; border:1px solid #E6E9FF; padding:10px; border-radius:8px; margin:8px 0; display:flex; justify-content:space-between; align-items:center; }
    .returned-badge { background:#D1FAE5; color:#065F46; padding:6px 10px; border-radius:8px; font-weight:bold; }
    .prestado-item-text { flex:1; font-size:18px; text-align:center; font-weight:600; color:#374151; }
    .prestado-equipo { color: #6B46C1; font-weight:700; }
        /* Next match banner (pastel colors) */
        #next-match-box {
            border-radius: 10px;
            padding: 18px;
            color: inherit;
        }
        /* (match-enviada control will be injected into the Next Match card) */
    #next-match-box table { width:100%; border-collapse: collapse; margin-top:10px; }
    #next-match-box th, #next-match-box td { padding:10px; border: 1px solid rgba(0,0,0,0.06); text-align:center; }
        #next-match-box .alliances { display:flex; gap:20px; justify-content:space-between; margin-top:8px; }
        #next-match-box .pila-uso { margin-top:14px; font-size:16px; font-weight:bold; text-align:center; }
        /* Modal de login */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .modal-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 320px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            text-align: left;
        }

        .modal-box h3 { margin-top: 0; color: #4B0082; }
        .modal-input { width: 100%; padding: 8px; margin: 8px 0; border-radius: 6px; border: 1px solid #E6E6FA; }
        .modal-actions { display:flex; justify-content: flex-end; gap:8px; margin-top:10px; }
        .matches-form {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .matches-form input, .matches-form textarea {
            padding: 8px;
            border: 1px solid #E6E6FA;
            border-radius: 6px;
        }

        .match-card {
            background: #F8FAFC;
            border: 1px solid #E6E9FF;
            padding: 12px;
            border-radius: 8px;
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .match-details { text-align: left; }

        .match-actions button { margin-left: 8px; }
    </style>
</head>
<body>
    <div id="ultima">
        √öltima actualizaci√≥n: {% if ultima_actualizacion %}{{ ultima_actualizacion }}{% else %}N/A{% endif %}
    </div>

    {% if proximo_chequeo %}
    <div id="proximo">
        Pr√≥ximo chequeo {{ proximo_chequeo }}
    </div>
    {% endif %}

    <!-- Imagen superior derecha -->
    <img src="/static/logo.png" alt="Logo" class="imagen-superior" onerror="this.style.display='none'">

    <h1 id="main-title">üîã Registro de Pilas üîã</h1>

    <!-- Pesta√±as -->
    <div class="tabs" role="tablist">
        <div class="tab active" data-target="panel-pilas" role="tab" aria-selected="true">Pilas</div>
        <div class="tab" data-target="panel-matches" role="tab" aria-selected="false">Matches</div>
        <div class="tab" data-target="panel-prestados" role="tab" aria-selected="false">Cosas Prestadas</div>
    </div>

    <div class="tab-panel" id="panel-pilas" role="tabpanel">
        <!-- Next match banner (full width) -->
        <div id="next-match" style="width:100%; margin-bottom:20px; display:none;">
            <!-- Se llenar√° por JS -->
        </div>

        <div class="formularios-container">
        <div class="registro-section">
            <h2>Registrar Pila üìù</h2>
            <form action="/agregar" method="post">
                <div class="campo-linea">
                    <label>Nombre:</label>
                    <select name="nombre" required>
                        <option value="">--Selecciona--</option>
                        <option value="Tlacua">Tlacua</option>
                        <option value="Jasper">Jasper</option>
                        <option value="Caditos">Caditos</option>
                        <option value="Timmy">Timmy</option>
                        <option value="Thunderbird">Thunderbird</option>
                        <option value="Miguelito">Miguelito</option>
                        <option value="Cesar√≠n">Cesar√≠n</option>
                        <option value="El t√≠o">El t√≠o</option>
                        <option value="Chopper">Chopper</option>
                        <option value="Gaia">Gaia</option>
                        <option value="Gipsy">Gipsy</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                    </select>
                </div>

                <div class="campo-linea">
                    <label>Carga (0-130):</label>
                    <input name="carga" type="number" min="0" max="130" required>
                </div>

                <div class="campo-linea">
                    <label>Ohms:</label>
                    <input name="ohms" type="number" step="0.001" required>
                </div>

                <button type="submit">Agregar pila</button>
            </form>
        </div>

        <div class="pila-uso-section">
            <h2>Pila en Uso ‚ö°Ô∏è</h2>
            <form action="/pila_en_uso" method="post">
                Seleccionar pila en uso:
                <select name="nombre" required>
                    <option value="">--Selecciona pila--</option>
                    <option value="Tlacua">Tlacua</option>
                    <option value="Jasper">Jasper</option>
                    <option value="Caditos">Caditos</option>
                    <option value="Timmy">Timmy</option>
                    <option value="Thunderbird">Thunderbird</option>
                    <option value="Miguelito">Miguelito</option>
                    <option value="Cesar√≠n">Cesar√≠n</option>
                    <option value="El t√≠o">El t√≠o</option>
                    <option value="Chopper">Chopper</option>
                    <option value="Gaia">Gaia</option>
                    <option value="Gipsy">Gipsy</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                </select><br><br>
                <button type="submit">Marcar como en uso</button>
            </form>
        </div>

        <div class="recibir-section">
            <h2>Recibir Pila ü™´</h2>
            <form action="/recibir_pila" method="post">
                Seleccionar pila recibida:
                <select name="nombre" required>
                    <option value="">--Selecciona pila--</option>
                    <option value="Tlacua">Tlacua</option>
                    <option value="Jasper">Jasper</option>
                    <option value="Caditos">Caditos</option>
                    <option value="Timmy">Timmy</option>
                    <option value="Thunderbird">Thunderbird</option>
                    <option value="Miguelito">Miguelito</option>
                    <option value="Cesar√≠n">Cesar√≠n</option>
                    <option value="El t√≠o">El t√≠o</option>
                    <option value="Chopper">Chopper</option>
                    <option value="Gaia">Gaia</option>
                    <option value="Gipsy">Gipsy</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                </select><br><br>
                <button type="submit">Marcar como recibida</button>
            </form>
        </div>
        </div>

        <div class="tablas-container">
            <div class="tabla-section">
                <h2>Listado de Pilas</h2>
                <table>
                    <tr>
                        <th>Nombre</th>
                        <th>Carga</th>
                        <th>Ohms</th>
                    </tr>
                    {% for pila in pilas %}
                    <tr>
                        <td>{{ pila.nombre }}</td>
                {% if pila.nombre in pilas_en_uso %}
                    <td class="en-uso">En uso</td>
                    <td class="en-uso">En uso</td>
                        {% elif pila.nombre in pilas_en_cooldown %}
                            {% set cooldown_time = pilas_en_cooldown[pila.nombre] %}
                            {% set is_ready = False %}
                            {% for pila_lista in pilas_listas %}
                                {% if pila_lista.nombre == pila.nombre %}
                                    {% set is_ready = True %}
                                {% endif %}
                            {% endfor %}
                            {% if is_ready %}
                                <td class="lista-conectar">Lista para conectar</td>
                                <td class="lista-conectar">Lista para conectar</td>
                            {% else %}
                                <td class="en-cooldown">En cooldown</td>
                                <td class="en-cooldown">En cooldown</td>
                            {% endif %}
                        {% elif pila.carga == "Sin datos" %}
                            <td class="lista-conectar">Lista para conectar</td>
                            <td class="lista-conectar">Lista para conectar</td>
                        {% else %}
                            <td>{{ pila.carga }}</td>
                            <td>{{ pila.ohms }}</td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </table>
            </div>

            <div class="tabla-section">
                <h2>Pilas Listas para Conectar</h2>
                {% if pilas_listas %}
                    <p style="color: #4B0082; font-weight: bold; margin-bottom: 15px;">Orden por tiempo sin conectar (m√°s antiguos primero):</p>
                    <ol style="color: #4B0082; text-align: left; font-weight: bold; font-size: 16px; line-height: 1.8;">
                        {% for pila_lista in pilas_listas %}
                            {% set disabled = pila_lista.disabled if pila_lista.disabled is defined else False %}
                            <li class="pila-list-item {{ 'disabled' if disabled else '' }}">
                                <span style="flex:1;">{{ pila_lista.nombre }}</span>
                                <form action="/toggle_inhabilitar" method="post" style="margin:0;">
                                    <input type="hidden" name="nombre" value="{{ pila_lista.nombre }}" />
                                    <button type="submit" class="pila-toggle-btn {{ 'enable' if disabled else 'disable' }}">{{ 'Habilitar' if disabled else 'Inhabilitar Pila' }}</button>
                                </form>
                            </li>
                        {% endfor %}
                    </ol>
                {% else %}
                    <p style="color: #6B7280; font-style: italic; text-align: center; margin-top: 40px;">No hay pilas listas para conectar en este momento.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="tab-panel" id="panel-matches" role="tabpanel" style="display:none;">
        <div class="matches-content">
            <h2>Match</h2>
            <div class="matches-form">
                <button id="add-match">Agregar</button>
            </div>

            <div id="matches-list">
                <!-- Cards de matches aparecer√°n aqu√≠ -->
            </div>

            <div style="margin-top:12px; text-align:center;">
                <button id="clear-matches">Limpiar todos los matches</button>
            </div>
        </div>
    </div>

    <div class="tab-panel" id="panel-prestados" role="tabpanel" style="display:none;">
        <div class="matches-content">
            <h2>Cosas Prestadas</h2>
            <div style="display:flex; justify-content:center; gap:12px; margin-bottom:16px;">
                <button id="add-prestado">Agregar</button>
            </div>

            <div id="prestados-list">
                <p style="color:#6B7280; text-align:center;">No hay items prestados.</p>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:18px;">
                <h3 style="margin:0;">Cosas Devueltas</h3>
                <button id="clear-devueltos" style="background:linear-gradient(135deg,#FDBA74,#F59E0B); color:white; border:none; padding:8px 10px; border-radius:8px; cursor:pointer;">Limpiar Devueltos</button>
            </div>
            <div id="devueltos-list">
                <p style="color:#6B7280; text-align:center;">No hay items devueltos.</p>
            </div>
        </div>
    </div>

    <!-- Modal de login para Matches -->
    <div id="login-modal" class="modal-overlay" style="display:none;">
        <div class="modal-box">
            <h3>Acceso a Matches</h3>
            <p>Ingresa credenciales</p>
            <input id="login-user" class="modal-input" placeholder="Usuario" />
            <input id="login-pass" type="password" class="modal-input" placeholder="Contrase√±a" />
            <div class="modal-actions">
                <button id="login-cancel">Cancelar</button>
                <button id="login-ok">Entrar</button>
            </div>
        </div>
    </div>

    <!-- Modal para agregar match (3 rojos, 3 azules) -->
    <div id="addmatch-modal" class="modal-overlay" style="display:none;">
        <div class="modal-box">
            <h3>Agregar Match</h3>
            <p>
                <label style="font-weight:bold;">N√∫mero de match: <input id="match-number" class="modal-input" placeholder="Ej: 1" style="width:120px; display:inline-block; margin-left:8px;" /></label>
            </p>
            <p>Referencia: <strong>7421</strong></p>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <input id="r1" class="modal-input" type="number" placeholder="Red 1" />
                <input id="r2" class="modal-input" type="number" placeholder="Red 2" />
                <input id="r3" class="modal-input" type="number" placeholder="Red 3" />
                <input id="b1" class="modal-input" type="number" placeholder="Blue 1" />
                <input id="b2" class="modal-input" type="number" placeholder="Blue 2" />
                <input id="b3" class="modal-input" type="number" placeholder="Blue 3" />
            </div>
            <div class="modal-actions">
                <button id="addmatch-cancel">Cancelar</button>
                <button id="addmatch-ok">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal para agregar prestado -->
    <div id="addprestado-modal" class="modal-overlay" style="display:none;">
        <div class="modal-box">
            <h3>Agregar Item Prestado</h3>
            <p>
                <label style="font-weight:bold;">N√∫mero de equipo: <input id="prestado-equipo" class="modal-input" placeholder="Ej: 7421" style="width:120px; display:inline-block; margin-left:8px;" /></label>
            </p>
            <p>
                <label style="font-weight:bold;">Qu√© se prest√≥:</label>
                <input id="prestado-item" class="modal-input" placeholder="Ej: Control remoto" />
            </p>
            <div class="modal-actions">
                <button id="addprestado-cancel">Cancelar</button>
                <button id="addprestado-ok">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Bot√≥n de reiniciar -->
    <button class="reiniciar-btn" onclick="confirmarReiniciar()">üîÑ Reiniciar Todo</button>

    <!-- Bot√≥n de informaci√≥n -->
    <button class="info-btn" onclick="mostrarInformacion()">‚ÑπÔ∏è Informaci√≥n</button>

    <script>
        // Tabs logic
        document.addEventListener('DOMContentLoaded', function() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Desactivar todas
                    tabs.forEach(t => { t.classList.remove('active'); t.setAttribute('aria-selected', 'false'); });

                    // Si la pesta√±a es matches, verificar auth
                    const target = tab.getAttribute('data-target');
                    if (target === 'panel-matches'){
                        const authed = sessionStorage.getItem('overpilas_matches_auth') === '1';
                        if (!authed){
                            // Mostrar modal de login
                            document.getElementById('login-modal').style.display = 'flex';
                            // no activar la tab a√∫n
                            return;
                        }
                    }

                    // Ocultar paneles
                    document.querySelectorAll('.tab-panel').forEach(panel => panel.style.display = 'none');

                    // Activar seleccionado
                    tab.classList.add('active');
                    tab.setAttribute('aria-selected', 'true');
                    const panel = document.getElementById(target);
                    if (panel) panel.style.display = 'block';

                    // Cambiar t√≠tulo principal seg√∫n pesta√±a
                    const mainTitle = document.getElementById('main-title');
                    if(mainTitle){
                        if(target === 'panel-matches') mainTitle.textContent = 'üìù Registro de Matches üìù';
                        else mainTitle.textContent = 'üîã Registro de Pilas üîã';
                    }
                });
            });
        });

        function confirmarReiniciar() {
            if (confirm("‚ö†Ô∏è ¬øEst√°s seguro de que quieres reiniciar TODOS los datos?\n ‚ö†Ô∏è No deber√≠as hacerlo por nada en teor√≠a ‚ö†Ô∏è\n‚Ä¢ ")) {
                // Si el usuario confirma, enviar formulario
                document.getElementById('reiniciarForm').submit();
            }
        }

        function mostrarInformacion() {
            const info = `Instrucciones de uso:

- Cada 30 min: registrar estado en "Registrar Pila".
- Marcar la pila en "Pila en Uso" cuando la uses.
- Al retirarla, registrar en "Recibir Pila" (cooldown 30 min).
- Las pilas listas se ordenan por tiempo sin conectar (m√°s antiguas primero).
- Marcar si se gan√≥ o perdi√≥ la partida
- "Reiniciar Todo" borra TODOS los datos.

Usar desde una sola computadora o sincronizar manualmente el archivo JSON.

Contacto: Rigo`;

            alert(info);
        }

        // Matches JS - client-side localStorage
        (function(){
            const KEY = 'overpilas_matches_v1';

            function read() {
                try { return JSON.parse(localStorage.getItem(KEY) || '[]'); }
                catch(e){ return []; }
            }

            function write(arr){ localStorage.setItem(KEY, JSON.stringify(arr)); }

            function render(){
                // Render matches from first to last (ascending by matchNumber, fallback to created)
                const raw = read() || [];
                const list = raw.slice().sort((a,b)=>{
                    const an = Number(a.matchNumber);
                    const bn = Number(b.matchNumber);
                    if(!isNaN(an) && !isNaN(bn)) return an - bn;
                    if(a.created && b.created) return new Date(a.created) - new Date(b.created);
                    return 0;
                });
                const container = document.getElementById('matches-list');
                if(!container) return;
                container.innerHTML = '';
                if(list.length === 0){ container.innerHTML = '<p style="color:#6B7280;">No hay matches a√∫n.</p>'; return; }
                list.forEach((m, idx) =>{
                    const div = document.createElement('div');
                    div.className = 'match-card';
                    function fmt(n){ const s = escapeHtml(String(n)); return s === '7421' ? `<strong>${s}</strong>` : s; }
                    const rojos = (m.rojos || []).map(n=>fmt(n)).join(' ‚Ä¢ ');
                    const azules = (m.azules || []).map(n=>fmt(n)).join(' ‚Ä¢ ');
                    const matchNumLabel = m.matchNumber ? `<div style="font-weight:bold; margin-bottom:6px;">Match #${escapeHtml(String(m.matchNumber))}</div>` : '';
                    // Result badge + timestamp (result_at)
                    let resultBadge = '';
                    if(m.result){
                        if(m.result === 'win') {
                            const ts = m.result_at ? escapeHtml(new Date(m.result_at).toLocaleString()) : '';
                            resultBadge = `<div style="margin-top:8px;"><span style="background:#DCFCE7;color:#065F46;padding:4px 8px;border-radius:6px;font-weight:bold;">Ganamos</span>${ts ? `<div style="font-size:11px;color:#065F46;margin-top:6px;">${ts}</div>` : ''}</div>`;
                        }
                        else if(m.result === 'loss') {
                            const ts = m.result_at ? escapeHtml(new Date(m.result_at).toLocaleString()) : '';
                            resultBadge = `<div style="margin-top:8px;"><span style="background:#FFE4E6;color:#9B1C1C;padding:4px 8px;border-radius:6px;font-weight:bold;">Perdimos</span>${ts ? `<div style="font-size:11px;color:#9B1C1C;margin-top:6px;">${ts}</div>` : ''}</div>`;
                        }
                    }
                    // Right-side badge HTML
                    let rightBadge = '';
                    if(m.result){
                        if(m.result === 'win'){
                            const ts = m.result_at ? escapeHtml(new Date(m.result_at).toLocaleString()) : '';
                            rightBadge = `<div style="text-align:center;"><div style="background:#10B981;color:white;padding:8px 12px;border-radius:8px;font-weight:bold;font-size:14px;">WIN</div>${ts?`<div style=\"font-size:11px;color:#065F46;margin-top:6px;\">${ts}</div>`:''}</div>`;
                        } else if(m.result === 'loss'){
                            const ts = m.result_at ? escapeHtml(new Date(m.result_at).toLocaleString()) : '';
                            rightBadge = `<div style="text-align:center;"><div style="background:#EF4444;color:white;padding:8px 12px;border-radius:8px;font-weight:bold;font-size:14px;">LOOSE</div>${ts?`<div style=\"font-size:11px;color:#9B1C1C;margin-top:6px;\">${ts}</div>`:''}</div>`;
                        }
                    }

                    div.innerHTML = `<div style="flex:1; text-align:left;">${matchNumLabel}<div><strong style="color:#DC2626">Red Alliance:</strong> ${rojos}</div><div><strong style="color:#2563EB">Blue Alliance:</strong> ${azules}</div><div style="font-size:12px;color:#6B7280; margin-top:6px;">${new Date(m.created).toLocaleString()}</div></div><div style="margin-left:12px; display:flex; flex-direction:column; align-items:center; justify-content:center;">${rightBadge}<div style="margin-top:8px;"><button data-idx="${idx}" class="del">Borrar</button></div></div>`;
                    container.appendChild(div);
                });
                // expose render so other code can refresh the list
                window.renderMatches = render;
                container.querySelectorAll('.del').forEach(btn => btn.addEventListener('click', () =>{
                    const idx = parseInt(btn.getAttribute('data-idx'));
                    const arr = read(); arr.splice(idx,1); write(arr); render();
                }));
            }

            function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]); }

            document.addEventListener('DOMContentLoaded', ()=>{
                const addBtn = document.getElementById('add-match');
                const clearBtn = document.getElementById('clear-matches');
                const addModal = document.getElementById('addmatch-modal');
                const addOk = document.getElementById('addmatch-ok');
                const addCancel = document.getElementById('addmatch-cancel');

                render();

                if(addBtn){ addBtn.addEventListener('click', ()=>{ addModal.style.display = 'flex'; }); }

                if(addCancel){ addCancel.addEventListener('click', ()=>{ addModal.style.display = 'none'; }); }

                if(addOk){ addOk.addEventListener('click', ()=>{
                    // Leer valores
                    const matchNumber = document.getElementById('match-number').value.trim();
                    const r1 = document.getElementById('r1').value.trim();
                    const r2 = document.getElementById('r2').value.trim();
                    const r3 = document.getElementById('r3').value.trim();
                    const b1 = document.getElementById('b1').value.trim();
                    const b2 = document.getElementById('b2').value.trim();
                    const b3 = document.getElementById('b3').value.trim();

                    // Validar que todos sean n√∫meros y est√©n presentes
                    const vals = [r1,r2,r3,b1,b2,b3];
                    if(matchNumber === ''){ alert('Ingresa el n√∫mero de match.'); return; }
                    if(vals.some(v=>v==='')){ alert('Por favor ingresa los 6 n√∫meros.'); return; }
                    if(vals.some(v=>isNaN(Number(v)))){ alert('Todos los valores deben ser n√∫meros.'); return; }

                    const match = {
                        matchNumber: matchNumber,
                        rojos: [Number(r1), Number(r2), Number(r3)],
                        azules: [Number(b1), Number(b2), Number(b3)],
                        created: new Date().toISOString()
                    };
                    const arr = read(); arr.unshift(match); write(arr);
                    // limpiar inputs
                    ['match-number','r1','r2','r3','b1','b2','b3'].forEach(id=>document.getElementById(id).value='');
                    addModal.style.display = 'none';
                    render();
                }); }

                if(clearBtn){ clearBtn.addEventListener('click', ()=>{ if(confirm('Limpiar TODOS los matches?')){ write([]); render(); } }); }
            });
        })();

        // Cosas Prestadas - client-side localStorage (key: overpilas_prestados_v1)
        (function(){
            const KEY_PRE = 'overpilas_prestados_v1';
            const KEY_DEV = 'overpilas_devueltos_v1';
            function read(key){ try{ return JSON.parse(localStorage.getItem(key)||'[]'); }catch(e){ return []; } }
            function write(key, arr){ localStorage.setItem(key, JSON.stringify(arr)); }
            function render(){
                const list = read(KEY_PRE);
                const container = document.getElementById('prestados-list');
                const devContainer = document.getElementById('devueltos-list');
                if(!container || !devContainer) return;
                container.innerHTML = '';
                devContainer.innerHTML = '';
                if(!list || list.length===0){ container.innerHTML = '<p style="color:#6B7280; text-align:center;">No hay items prestados.</p>'; }
                else{
                    list.forEach((it, idx)=>{
                        const div = document.createElement('div');
                        div.className = 'prestado-card';
                        const left = document.createElement('div');
                        left.innerHTML = `<div style="display:flex; gap:10px; align-items:center; width:100%;"><div class=\"prestado-equipo\">Equipo ${escapeHtml(it.equipo)}</div><div class=\"prestado-item-text\">${escapeHtml(it.item)}</div></div><div style=\"font-size:11px;color:#6B7280;margin-top:6px;\">${new Date(it.created).toLocaleString()}</div>`;
                        const right = document.createElement('div');
                        right.innerHTML = `<div><button data-idx="${idx}" class="mark-return">Devuelto</button></div>`;
                        div.appendChild(left); div.appendChild(right); container.appendChild(div);
                    });
                }

                const devs = read(KEY_DEV);
                if(!devs || devs.length===0){ devContainer.innerHTML = '<p style="color:#6B7280; text-align:center;">No hay items devueltos.</p>'; }
                else{
                    devs.forEach((it, idx)=>{
                        const div = document.createElement('div');
                        div.className = 'prestado-card';
                        div.innerHTML = `<div style="flex:1;"><div style=\"display:flex; gap:10px; align-items:center; width:100%;\"><div class=\"prestado-equipo\">Equipo ${escapeHtml(it.equipo)}</div><div class=\"prestado-item-text\">${escapeHtml(it.item)}</div></div><div style=\"font-size:11px;color:#6B7280;margin-top:6px;\">${new Date(it.created).toLocaleString()}</div></div><div><div class=\"returned-badge\">Devuelto</div></div>`;
                        devContainer.appendChild(div);
                    });
                }

                document.querySelectorAll('.mark-return').forEach(btn=>btn.addEventListener('click', ()=>{
                    const i = Number(btn.getAttribute('data-idx'));
                    const arr = read(KEY_PRE);
                    if(!arr[i]) return;
                    const item = arr.splice(i,1)[0];
                    write(KEY_PRE, arr);
                    const devs2 = read(KEY_DEV);
                    devs2.unshift(item);
                    write(KEY_DEV, devs2);
                    render();
                }));
            }
            function escapeHtml(s){ return String(s||'').replace(/[&<>'"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":"&#39;"})[c]); }

            document.addEventListener('DOMContentLoaded', ()=>{
                const addBtn = document.getElementById('add-prestado');
                const modal = document.getElementById('addprestado-modal');
                const ok = document.getElementById('addprestado-ok');
                const cancel = document.getElementById('addprestado-cancel');
                render();
                if(addBtn) addBtn.addEventListener('click', ()=>{ modal.style.display='flex'; });
                if(cancel) cancel.addEventListener('click', ()=>{ modal.style.display='none'; });
                if(ok) ok.addEventListener('click', ()=>{
                    const equipo = document.getElementById('prestado-equipo').value.trim();
                    const item = document.getElementById('prestado-item').value.trim();
                    if(!equipo || !item){ alert('Completa ambos campos'); return; }
                    const arr = read(KEY_PRE); arr.unshift({ equipo: equipo, item: item, created: new Date().toISOString() }); write(KEY_PRE, arr);
                    document.getElementById('prestado-equipo').value=''; document.getElementById('prestado-item').value=''; modal.style.display='none'; render();
                });
                // Clear devueltos button
                const clearDevBtn = document.getElementById('clear-devueltos');
                if(clearDevBtn) clearDevBtn.addEventListener('click', ()=>{
                    if(!confirm('¬øLimpiar TODOS los items devueltos?')) return;
                    write(KEY_DEV, []);
                    render();
                });
            });
        })();

                // Next match banner: leer matches de localStorage y mostrar el siguiente (menor matchNumber)
                (function(){
                    function getNextMatch(){
                        try{
                            const arr = JSON.parse(localStorage.getItem('overpilas_matches_v1')||'[]');
                            if(!arr || arr.length===0) return null;
                            // Filtrar con matchNumber y orden ascendente por n√∫mero (num√©rico)
                            const filtered = arr.filter(m=>m.matchNumber!==undefined && m.matchNumber!=='');
                            if(filtered.length===0) return null;
                            filtered.sort((a,b)=> Number(a.matchNumber) - Number(b.matchNumber));
                            return filtered[0];
                        }catch(e){ return null; }
                    }

                    function renderNext(){
                            const container = document.getElementById('next-match');
                            if(!container) return;

                            // Load and sort matches
                            const arr = JSON.parse(localStorage.getItem('overpilas_matches_v1')||'[]') || [];
                            if(!arr || arr.length === 0){ container.style.display = 'none'; return; }
                            const sorted = arr.slice().filter(m=>m.matchNumber!==undefined && m.matchNumber!=='').sort((a,b)=> Number(a.matchNumber)-Number(b.matchNumber));

                            // initialize current index if not present
                            if(typeof window._op_matches_sorted === 'undefined') window._op_matches_sorted = sorted;
                            else window._op_matches_sorted = sorted;
                            if(typeof window._op_current_index === 'undefined'){
                                // find first without result
                                let i = sorted.findIndex(m=>!m.result);
                                window._op_current_index = i === -1 ? 0 : i;
                            } else {
                                // clamp index
                                if(window._op_current_index < 0) window._op_current_index = 0;
                                if(window._op_current_index >= sorted.length) window._op_current_index = sorted.length-1;
                            }

                            const current = window._op_matches_sorted[window._op_current_index];
                            if(!current){ container.style.display='none'; return; }

                            // Helpers
                            function esc(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]); }
                            function fmt(n){ const s = String(n); return s === '7421' ? `<strong><u>${esc(s)}</u></strong>` : esc(s); }

                            const inRed = (current.rojos||[]).map(String).includes('7421');
                            const inBlue = (current.azules||[]).map(String).includes('7421');
                            const color = inRed ? '#FFE6E6' : (inBlue ? '#E6F2FF' : '#F7F7F8');
                            const textColor = inRed ? '#6B0F0F' : (inBlue ? '#09326C' : '#333333');

                            const rojos = (current.rojos||[]).map(fmt).join(' ‚Ä¢ ');
                            const azules = (current.azules||[]).map(fmt).join(' ‚Ä¢ ');

                            const html = `
                                <div id="next-match-box" style="background:${color}; color:${textColor};">
                                    <div style="display:flex; justify-content:center; align-items:center; gap:16px; margin-bottom:8px;">
                                        <button id="nm-prev" style="background:linear-gradient(180deg,#7C3AED,#9F7AEA); color:#fff; border:none; padding:10px 14px; border-radius:10px; box-shadow:0 6px 16px rgba(124,58,237,0.18); cursor:pointer; font-weight:bold;">Prev</button>
                                        <div style="text-align:center; font-size:18px; font-weight:bold;">Siguiente match #${esc(String(current.matchNumber))}</div>
                                        <button id="nm-next" style="background:linear-gradient(180deg,#7C3AED,#9F7AEA); color:#fff; border:none; padding:10px 14px; border-radius:10px; box-shadow:0 6px 16px rgba(124,58,237,0.18); cursor:pointer; font-weight:bold;">Next</button>
                                    </div>
                                    <div style="text-align:center; font-size:12px; color:${textColor}; margin-bottom:8px;">${window._op_current_index+1} / ${window._op_matches_sorted.length}</div>
                                    <table style="margin-top:8px;">
                                        <tr><th style="background:rgba(0,0,0,0.03)">Red Alliance</th><th style="background:rgba(0,0,0,0.03)">Blue Alliance</th></tr>
                                        <tr><td style="color:${textColor};">${rojos}</td><td style="color:${textColor};">${azules}</td></tr>
                                    </table>
                                    <div class="pila-uso">Pila a utilizar: <strong>{{ mejor_pila if mejor_pila else 'N/A' }}</strong></div>
                                    <div style="margin-top:12px; text-align:center; display:flex; gap:8px; justify-content:center;">
                                        <button id="match-ganamos-btn" style="padding:8px 12px; border-radius:8px; background:#10B981; color:white; border:none; font-weight:bold; cursor:pointer;">Win</button>
                                        <button id="match-perdimos-btn" style="padding:8px 12px; border-radius:8px; background:#EF4444; color:white; border:none; font-weight:bold; cursor:pointer;">Loose</button>
                                    </div>
                                </div>
                            `;

                            container.innerHTML = html;
                            container.style.display = 'block';

                            // attach buttons
                            try{
                                const g = document.getElementById('match-ganamos-btn');
                                const p = document.getElementById('match-perdimos-btn');
                                const prev = document.getElementById('nm-prev');
                                const nextBtn = document.getElementById('nm-next');
                                if(g){ g.removeEventListener('click', onWin); g.addEventListener('click', onWin); }
                                if(p){ p.removeEventListener('click', onLoose); p.addEventListener('click', onLoose); }
                                if(prev){ prev.removeEventListener('click', onPrev); prev.addEventListener('click', onPrev); }
                                if(nextBtn){ nextBtn.removeEventListener('click', onNext); nextBtn.addEventListener('click', onNext); }
                            }catch(e){}
                    }

                    // Ejecutar al cargar y cada vez que cambie localStorage
                    document.addEventListener('DOMContentLoaded', ()=>{ renderNext(); });
                    window.addEventListener('storage', renderNext);

                    // Marca el resultado ('win' o 'loss') en la match actual mostrada y avanza (o deja index en siguiente sin resultado)
                    function marcarResultado(resultado){
                        try{
                            const key = 'overpilas_matches_v1';
                            const arr = JSON.parse(localStorage.getItem(key) || '[]');
                            if(!arr || arr.length===0) return;
                            // We operate on the currently shown match in window._op_matches_sorted[window._op_current_index]
                            const sorted = (window._op_matches_sorted || []).slice();
                            const curr = sorted[window._op_current_index];
                            if(!curr) return;
                            // Find index in original arr
                            const idx = arr.findIndex(m => String(m.matchNumber) === String(curr.matchNumber) && JSON.stringify(m.rojos) === JSON.stringify(curr.rojos) && JSON.stringify(m.azules) === JSON.stringify(curr.azules) && m.created === curr.created);
                            if(idx !== -1){
                                arr[idx].result = resultado; // 'win' or 'loss'
                                arr[idx].result_at = new Date().toISOString();
                                localStorage.setItem(key, JSON.stringify(arr));
                                // advance index to next match without result if available
                                const filtered = arr.filter(m=>m.matchNumber!==undefined && m.matchNumber!=='').sort((a,b)=> Number(a.matchNumber)-Number(b.matchNumber));
                                let nextIndex = filtered.findIndex(m=>!m.result);
                                if(nextIndex === -1) nextIndex = Math.min(window._op_current_index+1, filtered.length-1);
                                window._op_matches_sorted = filtered;
                                window._op_current_index = nextIndex;
                                // Re-render both next match and matches list
                                renderNext();
                                if(typeof window.renderMatches === 'function') window.renderMatches();
                                else window.dispatchEvent(new Event('storage'));
                                // Also update server-side piles: mark previous pila_en_uso as received and set the suggested pile as en_uso
                                try{
                                    // read suggested pile from the rendered Next Match box
                                    const pilaElem = document.querySelector('#next-match-box .pila-uso strong');
                                    const suggested = pilaElem ? pilaElem.textContent.trim() : '';
                                    // previous pilas en uso from server-side render (initial value)
                                    const prevJson = '{{ pilas_en_uso | tojson }}';
                                    let prevList = [];
                                    try{ prevList = prevJson ? JSON.parse(prevJson) : []; }catch(e){ prevList = []; }
                                    // Mark any previous pilas that are different from the suggested one as received
                                    prevList.forEach(prev => {
                                        try{
                                            if(prev && prev !== '' && prev !== suggested){
                                                fetch('/recibir_pila', {method:'POST', headers: {'Content-Type':'application/x-www-form-urlencoded'}, body: `nombre=${encodeURIComponent(prev)}`}).catch(()=>{});
                                            }
                                        }catch(e){}
                                    });
                                    if(suggested && suggested !== '' && suggested !== 'N/A'){
                                        // mark suggested as in use
                                        fetch('/pila_en_uso', {method:'POST', headers: {'Content-Type':'application/x-www-form-urlencoded'}, body: `nombre=${encodeURIComponent(suggested)}`}).catch(()=>{});
                                    }
                                }catch(e){ console.error('Error updating server piles', e); }
                            }
                        }catch(e){ console.error('Error al marcar resultado', e); }
                    }

                    // No confirmation: directly mark result and advance
                    function onWin(e){ marcarResultado('win'); }
                    function onLoose(e){ marcarResultado('loss'); }

                    function onPrev(e){
                        if(typeof window._op_current_index === 'undefined') return;
                        window._op_current_index = Math.max(0, window._op_current_index - 1);
                        renderNext();
                    }

                    function onNext(e){
                        if(typeof window._op_current_index === 'undefined') return;
                        window._op_current_index = Math.min((window._op_matches_sorted||[]).length - 1, window._op_current_index + 1);
                        renderNext();
                    }
                })();

        // Login modal logic
        (function(){
            const USER = 'mentores';
            const PASS = '7421';

            function closeModal(){ document.getElementById('login-modal').style.display = 'none'; }

            document.addEventListener('DOMContentLoaded', ()=>{
                const ok = document.getElementById('login-ok');
                const cancel = document.getElementById('login-cancel');
                ok.addEventListener('click', ()=>{
                    const user = document.getElementById('login-user').value;
                    const pass = document.getElementById('login-pass').value;
                    if(user === USER && pass === PASS){
                        sessionStorage.setItem('overpilas_matches_auth','1');
                        closeModal();
                        // activar la pesta√±a matches program√°ticamente
                        const tab = document.querySelector('.tab[data-target="panel-matches"]');
                        if(tab) {
                            tab.click();
                            // Also update title explicitly
                            const mainTitle = document.getElementById('main-title');
                            if(mainTitle) mainTitle.textContent = 'üìù Registro de Matches üìù';
                        }
                    } else {
                        alert('Usuario o contrase√±a incorrectos');
                    }
                });
                cancel.addEventListener('click', ()=>{ closeModal(); });
            });
        })();
    </script>

    <!-- Formulario oculto para reiniciar -->
    <form id="reiniciarForm" action="/reiniciar" method="post" style="display: none;">
    </form>
    <!-- (Match enviada button is embedded in the Next Match card) -->
</body>
</html>
